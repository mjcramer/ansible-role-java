---
- name: create hosts for role test
  hosts: localhost
  gather_facts: no
  connection: local

  vars_files:
    - common.yml
    - secret.yml

  vars:
    os_images:
      fedora: fedora-30-x64
      centos: centos-7-x64
      debian: debian-9-x64
      ubuntu: ubuntu-18-04-x64

  tasks:
    - name: create cache directory
      file:
        path: "{{ cache_dir }}"
        state: directory
        mode: 0755

    - name: create private directory
      file:
        path: "{{ private_dir }}"
        state: directory
        mode: 0700

    - openssh_keypair:
        path: "{{ ssh_private_key_file }}"
        size: 2048
      register: keypair

    - name: register ssh key
      digital_ocean_sshkey:
        oauth_token: "{{ digitalocean_api_key }}"
        name: "{{ ssh_key_name }}"
        ssh_pub_key: "{{ keypair.public_key | str }}"
        state: present
      register: ssh_key

    - name: create droplets
      digital_ocean_droplet:
        state: present
        name: "{{ host_name }}-{{ item.key }}"
        unique_name: yes
        size: 2gb
        region: sfo2
        image: "{{ item.value }}"
        ssh_keys: 
        - "{{ ssh_key.data.ssh_key.id }}"
        oauth_token: "{{ digitalocean_api_key }}"
        wait_timeout: 500
        monitoring: no
      loop: "{{ os_images | dict2items }}"
      register: droplets
        
    - debug:
        var: droplets

    - name: save variables
      copy:
        content: "{{ item.value | to_nice_json }}" 
        dest: "{{ cache }}/{{ item.key }}"
      with_items:
      - key: droplet_ids
        value: "{{ droplets.results | map(attribute='data.droplet.id') | list }}"
      - key: ssh_key_fingerprint
        value: "{{ ssh_key.data.ssh_key.fingerprint }}"
  
    - name: write inventory
      template:
        src: inventory.yml.j2
        dest: "{{ cache_dir }}/inventory.yml"


